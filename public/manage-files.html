<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Files</title>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #f7f7f8; color: #111; }
    .topbar { display: flex; align-items: center; justify-content: space-between; background: #111; color: #fff; padding: 12px 16px; }
    .brand { font-weight: 600; }
    .left { display: flex; align-items: center; }
    .menu { display: flex; gap: 24px; margin-left: 24px; }
    .menu > .item { position: relative; cursor: pointer; }
    .menu a { color: #fff; text-decoration: none; }
    .submenu { position: absolute; top: 100%; left: 0; background: #222; border: 1px solid #333; min-width: 180px; display: none; z-index: 1000; white-space: nowrap; overflow: visible; }
    .userbox { display: flex; align-items: center; gap: 12px; }
    .userbox a { color: #fff; text-decoration: underline; }
    .submenu a { display: block; padding: 10px 12px; color: #fff; }
    .submenu a:hover { background: #333; }
    .item:hover .submenu { display: block; }
    .page { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    th { background: #f3f4f6; }
    .chart { margin: 12px 0; }
    .bar-row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .bar-label { width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .bar-container { flex: 1; background: #f3f4f6; height: 16px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
    .bar { height: 100%; background: #3b82f6; }
    .bar-count { width: 60px; text-align: right; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="left">
      <div class="brand">Hello World App</div>
      <nav class="menu" aria-label="Main menu">
      <div class="item" id="adminMenu" aria-haspopup="true" aria-expanded="false">
        <a href="#" aria-label="Admin menu">Admin ▾</a>
        <div class="submenu" role="menu">
          <a role="menuitem" href="/manage-users.html">Manage users</a>
        </div>
      </div>
      <div class="item" aria-haspopup="true" aria-expanded="false">
        <a href="#" aria-label="Files menu">Files ▾</a>
        <div class="submenu" role="menu">
          <a role="menuitem" href="/manage-files.html">Manage files</a>
        </div>
      </div>
      </nav>
    </div>
    <div class="userbox">
      <span id="userEmail" class="muted">Loading…</span>
      <a href="#" id="signoutLink">Sign out</a>
    </div>
  </header>

  <main class="page">
    <div class="card">
      <h1>Manage files</h1>
      <form id="uploadForm" enctype="multipart/form-data">
        <div style="margin-bottom: 12px; display:flex; gap:12px; align-items:center;">
          <input type="file" name="file" id="fileInput" required />
          <button type="submit">Upload (your files)</button>
        </div>
      </form>
      <div id="adminFilter" style="margin:8px 0; display:none;">
        <label for="ownerSelect">Owner:</label>
        <select id="ownerSelect"></select>
      </div>
      <div id="stats" class="chart" style="display:none;">
        <h3 style="margin:8px 0;">User file counts</h3>
        <div style="display:flex; align-items:center; gap:12px; margin:8px 0;">
          <label for="metricSelect">Show:</label>
          <select id="metricSelect">
            <option value="count" selected>File count</option>
            <option value="bytes">Bytes</option>
          </select>
          <label for="topSelect">Top</label>
          <select id="topSelect">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
        <div id="chartBody"></div>
      </div>
      <table id="filesTable">
        <thead>
          <tr><th>Name</th><th>Size (bytes)</th><th>Uploaded</th><th>Actions</th><th>Link</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
  <script>
      let isAdmin = false;
      let currentEmail = '';
      let filterEmail = '';

      async function loadUser() {
        try {
          const res = await fetch('/auth/me');
          const json = await res.json();
          const userEl = document.getElementById('userEmail');
          if (json && json.ok) {
            userEl.textContent = json.email;
            currentEmail = json.email;
            isAdmin = json.role === 'ADMIN';
            document.getElementById('adminFilter').style.display = isAdmin ? 'block' : 'none';
            if (isAdmin) {
              await populateOwnerDropdown();
            }
          } else {
            window.location.href = '/';
          }
        } catch {}
      }

      async function populateOwnerDropdown() {
        try {
          const sel = document.getElementById('ownerSelect');
          sel.innerHTML = '';
          // Default option: current user's files
          const optMe = document.createElement('option');
          optMe.value = '';
          optMe.textContent = 'My files (current)';
          sel.appendChild(optMe);
          const res = await fetch('/admin/users');
          const j = await res.json();
          if (j && j.ok && Array.isArray(j.users)) {
            j.users
              .filter(u => u && u.email && u.email !== currentEmail)
              .forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.email;
                opt.textContent = `${u.email} (${u.role})`;
                sel.appendChild(opt);
              });
          }
          sel.addEventListener('change', async () => {
            filterEmail = sel.value;
            await loadFiles(filterEmail);
            await loadStats();
          });
        } catch {}
      }

      async function loadFiles(ownerEmail) {
        const params = ownerEmail && isAdmin ? ('?email=' + encodeURIComponent(ownerEmail)) : '';
        const res = await fetch('/files/list' + params);
        const json = await res.json();
        const tbody = document.querySelector('#filesTable tbody');
        tbody.innerHTML = '';
        if (json && json.ok) {
          (json.files || []).forEach(f => {
            const name = f.key.split('/').pop();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${name}</td><td>${f.size}</td><td>${new Date(f.uploaded).toLocaleString()}</td>
              <td><button data-name="${name}" class="linkBtn">Get link</button> <button data-name="${name}" class="delBtn">Delete</button></td>
              <td class="linkCell"></td>`;
            tbody.appendChild(tr);
          });
          tbody.querySelectorAll('.linkBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const name = e.target.getAttribute('data-name');
              const body = { name };
              if (isAdmin && filterEmail) body.email = filterEmail;
              const res = await fetch('/files/presign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
              });
              const j = await res.json();
              if (j && j.ok && j.url) {
                const row = e.target.closest('tr');
                const cell = row.querySelector('.linkCell');
                const expiry = new Date(j.expiresAt).toLocaleString();
                const linkHtml = `
                  <a href="${j.url}" target="_blank">Download link</a>
                  <button class="copyBtn" data-url="${j.url}">Copy</button>
                  <span class="muted">(expires: ${expiry})</span>
                `;
                cell.innerHTML = linkHtml;
                const copyBtn = cell.querySelector('.copyBtn');
                copyBtn.addEventListener('click', async (ev) => {
                  ev.preventDefault();
                  const url = copyBtn.getAttribute('data-url');
                  try {
                    await navigator.clipboard.writeText(url);
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => (copyBtn.textContent = 'Copy'), 1500);
                  } catch {}
                });
              }
            });
          });
          tbody.querySelectorAll('.delBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const name = e.target.getAttribute('data-name');
              const query = new URLSearchParams();
              query.set('name', name);
              if (isAdmin && filterEmail) query.set('email', filterEmail);
              await fetch('/files/delete?' + query.toString(), { method: 'DELETE' });
              await loadFiles(filterEmail);
              await loadStats();
            });
          });
        }
      }

      async function loadStats() {
        if (!isAdmin) return;
        const wrap = document.getElementById('stats');
        const body = document.getElementById('chartBody');
        const metricSel = document.getElementById('metricSelect');
        const topSel = document.getElementById('topSelect');
        wrap.style.display = 'block';
        body.innerHTML = '';
        try {
          const res = await fetch('/admin/files/stats');
          const j = await res.json();
          if (!(j && j.ok)) return;
          const stats = (j.stats || []).slice();
          const metric = (metricSel && metricSel.value) || 'count';
          const topN = parseInt((topSel && topSel.value) || '10', 10);
          stats.sort((a, b) => {
            const av = metric === 'bytes' ? (a.bytes || 0) : (a.count || 0);
            const bv = metric === 'bytes' ? (b.bytes || 0) : (b.count || 0);
            return bv - av;
          });
          const sliced = stats.slice(0, Math.max(1, topN));
          const max = Math.max(1, ...sliced.map(s => metric === 'bytes' ? (s.bytes || 0) : (s.count || 0)));
          sliced.forEach(s => {
            const row = document.createElement('div');
            row.className = 'bar-row';
            const value = metric === 'bytes' ? (s.bytes || 0) : (s.count || 0);
            const widthPct = ((100 * value) / max).toFixed(0);
            const labelVal = Number(value).toLocaleString();
            row.innerHTML = `
              <div class="bar-label" title="${s.email}">${s.email}</div>
              <div class="bar-container"><div class="bar" style="width:${widthPct}%"></div></div>
              <div class="bar-count">${labelVal}</div>
            `;
            body.appendChild(row);
          });
          if (metricSel) metricSel.onchange = async () => { await loadStats(); };
          if (topSel) topSel.onchange = async () => { await loadStats(); };
        } catch {}
      }

      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        // Always upload to current user's folder
        fd.delete('email');
        await fetch('/files/upload', { method: 'POST', body: fd });
        await loadFiles(filterEmail);
        await loadStats();
      });

      loadUser().then(async () => { await loadFiles(''); if (isAdmin) await loadStats(); });
      document.getElementById('signoutLink').addEventListener('click', async (e) => {
        e.preventDefault();
        try { await fetch('/auth/signout', { method: 'POST' }); } catch {}
        window.location.href = '/';
      });
  </script>
</body>
</html>
