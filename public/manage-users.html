<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Users</title>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #f7f7f8; color: #111; }
    .topbar { display: flex; align-items: center; justify-content: space-between; background: #111; color: #fff; padding: 12px 16px; }
    .brand { font-weight: 600; }
    .left { display: flex; align-items: center; }
    .menu { display: flex; gap: 24px; margin-left: 24px; }
    .menu > .item { position: relative; cursor: pointer; }
    .menu a { color: #fff; text-decoration: none; }
    .submenu { position: absolute; top: 100%; left: 0; background: #222; border: 1px solid #333; min-width: 180px; display: none; z-index: 1000; white-space: nowrap; overflow: visible; }
    .userbox { display: flex; align-items: center; gap: 12px; }
    .userbox a { color: #fff; text-decoration: underline; }
    .submenu a { display: block; padding: 10px 12px; color: #fff; }
    .submenu a:hover { background: #333; }
    .item:hover .submenu { display: block; }
    .page { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    th { background: #f3f4f6; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="left">
      <div class="brand">Hello World App</div>
      <nav class="menu" aria-label="Main menu">
      <div class="item" id="adminMenu" aria-haspopup="true" aria-expanded="false">
        <a href="#" aria-label="Admin menu">Admin ▾</a>
        <div class="submenu" role="menu">
          <a role="menuitem" href="/manage-users.html">Manage users</a>
        </div>
      </div>
      <div class="item" aria-haspopup="true" aria-expanded="false">
        <a href="#" aria-label="Files menu">Files ▾</a>
        <div class="submenu" role="menu">
          <a role="menuitem" href="/manage-files.html">Manage files</a>
        </div>
      </div>
      </nav>
    </div>
    <div class="userbox">
      <span id="userEmail" class="muted">Loading…</span>
      <a href="#" id="signoutLink">Sign out</a>
    </div>
  </header>

  <main class="page">
    <div class="card">
      <h1>Manage users</h1>
      <form id="addUserForm" style="margin-bottom:12px; display:flex; gap:12px; align-items:center;">
        <input type="email" id="newUserEmail" placeholder="user@example.com" required />
        <select id="newUserRole">
          <option value="USER">USER</option>
          <option value="ADMIN">ADMIN</option>
        </select>
        <button type="submit">Add user</button>
      </form>
      <table id="usersTable">
        <thead>
          <tr><th>Email</th><th>Role</th><th>Active</th><th>Created</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
  <script>
    let isAdmin = false;
    let currentEmail = '';

    async function loadUser() {
      try {
        const res = await fetch('/auth/me');
        const json = await res.json();
        const userEl = document.getElementById('userEmail');
        if (json && json.ok) {
          userEl.textContent = json.email;
          currentEmail = json.email;
          isAdmin = json.role === 'ADMIN';
          if (!isAdmin) {
            const admin = document.getElementById('adminMenu');
            if (admin) admin.style.display = 'none';
          }
          if (isAdmin) {
            await loadUsers();
          }
        } else {
          // Redirect unauthenticated users to the sign-in page
          window.location.href = '/';
        }
      } catch {}
    }
    async function loadUsers() {
      const res = await fetch('/admin/users');
      const j = await res.json();
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      if (j && j.ok) {
        (j.users || []).forEach(u => {
          const tr = document.createElement('tr');
          const createdStr = u.created_at ? new Date(u.created_at).toLocaleString() : '';
          tr.innerHTML = `
            <td>${u.email}</td>
            <td>
              <select class="roleSelect" data-email="${u.email}">
                <option value="USER" ${u.role === 'USER' ? 'selected' : ''}>USER</option>
                <option value="ADMIN" ${u.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
              </select>
            </td>
            <td>${u.is_active ? 'true' : 'false'}</td>
            <td>${createdStr}</td>
            <td>
              <button class="toggleBtn" data-email="${u.email}" data-active="${u.is_active ? 1 : 0}">${u.is_active ? 'Deactivate' : 'Activate'}</button>
              <button class="deleteBtn" data-email="${u.email}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('.roleSelect').forEach(sel => {
          sel.addEventListener('change', async (e) => {
            const email = e.target.getAttribute('data-email');
            const newRole = e.target.value;
            if (email === currentEmail && newRole !== 'ADMIN') {
              alert('Cannot change your own role to USER.');
              // revert selection back to ADMIN
              e.target.value = 'ADMIN';
              return;
            }
            const res = await fetch('/admin/users/role', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, role: newRole })
            });
            const jr = await res.json().catch(() => ({}));
            if (!(res.ok && jr && jr.ok)) {
              alert((jr && jr.error) || 'Failed to update role');
            } else {
              await loadUsers();
            }
          });
        });
        tbody.querySelectorAll('.toggleBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const email = e.target.getAttribute('data-email');
            const curr = e.target.getAttribute('data-active') === '1';
            const next = !curr;
            await fetch('/admin/users/toggle', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, active: next })
            });
            await loadUsers();
          });
        });
        tbody.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const email = e.target.getAttribute('data-email');
            if (email === currentEmail) { alert('Cannot delete yourself.'); return; }
            await fetch('/admin/users?email=' + encodeURIComponent(email), { method: 'DELETE' });
            await loadUsers();
          });
        });
      }
    }

    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('newUserEmail').value.trim();
      const role = document.getElementById('newUserRole').value;
      if (!email) return;
      const res = await fetch('/admin/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, role })
      });
      const j = await res.json().catch(() => ({}));
      if (res.ok && j && j.ok) {
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserRole').value = 'USER';
        await loadUsers();
      } else {
        alert((j && j.error) || 'Failed to add user');
      }
    });

    loadUser();
    document.getElementById('signoutLink').addEventListener('click', async (e) => {
      e.preventDefault();
      try { await fetch('/auth/signout', { method: 'POST' }); } catch {}
      window.location.href = '/';
    });
  </script>
</body>
</html>
